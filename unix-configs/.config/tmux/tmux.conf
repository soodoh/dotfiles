# -----------------------------------------------------------------------------
# General Settings
# -----------------------------------------------------------------------------

# Use Ctrl+g as prefix (like zellij's exit from locked mode)
unbind C-b
set -g prefix C-g
bind C-g send-prefix

# Enable mouse mode
set -g mouse on

# Start windows and panes at 1 (not 0)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Don't rename windows automatically
set -g allow-rename off

# Increase scrollback buffer
set -g history-limit 50000

# Reduce escape time for vim
set -sg escape-time 10

# Enable true color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",*256col*:RGB"

# Focus events (for vim/neovim)
set -g focus-events on

# Allow passthrough for image.nvim (kitty graphics protocol)
set -g allow-passthrough on

# Aggressive resize
setw -g aggressive-resize on

# -----------------------------------------------------------------------------
# Copy Mode / Clipboard (like zellij copy settings)
# -----------------------------------------------------------------------------

# Use vi mode for copy mode
setw -g mode-keys vi

# Copy to system clipboard (like zellij's copy_command "pbcopy")
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Vi-style copy mode bindings
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi Escape send-keys -X cancel

# -----------------------------------------------------------------------------
# Global Alt Bindings (work without prefix - like zellij's locked mode bindings)
# -----------------------------------------------------------------------------

# Sessionizer (project picker) - uses tms (tmux-sessionizer)
bind -n M-w display-popup -E "tms"
bind -n M-e display-popup -E "tms switch"

# Split panes (v=vertical side-by-side, s=horizontal stacked)
bind -n M-v split-window -h -c "#{pane_current_path}"
bind -n M-s split-window -v -c "#{pane_current_path}"

# Switch to last session
bind -n M-Tab switch-client -l

# New window
bind -n M-t new-window -c "#{pane_current_path}"

# Close current pane
bind -n M-x kill-pane

# Smart pane navigation (works with vim-tmux-navigator in neovim)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

# Navigate left (vim-aware), or previous window if at edge
bind -n M-Left if-shell "$is_vim" "send-keys M-Left" "if-shell '[ #{pane_at_left} -eq 1 ]' 'select-window -p' 'select-pane -L'"
bind -n M-h if-shell "$is_vim" "send-keys M-h" "if-shell '[ #{pane_at_left} -eq 1 ]' 'select-window -p' 'select-pane -L'"

# Navigate right (vim-aware), or next window if at edge
bind -n M-Right if-shell "$is_vim" "send-keys M-Right" "if-shell '[ #{pane_at_right} -eq 1 ]' 'select-window -n' 'select-pane -R'"
bind -n M-l if-shell "$is_vim" "send-keys M-l" "if-shell '[ #{pane_at_right} -eq 1 ]' 'select-window -n' 'select-pane -R'"

# Navigate up (vim-aware)
bind -n M-Up if-shell "$is_vim" "send-keys M-Up" "select-pane -U"
bind -n M-k if-shell "$is_vim" "send-keys M-k" "select-pane -U"

# Navigate down (vim-aware)
bind -n M-Down if-shell "$is_vim" "send-keys M-Down" "select-pane -D"
bind -n M-j if-shell "$is_vim" "send-keys M-j" "select-pane -D"

# Scroll up/down (enters copy mode if not already)
bind -n M-u copy-mode \; send-keys -X halfpage-up
bind -n M-d copy-mode \; send-keys -X halfpage-down

# Move window left
bind -n M-i swap-window -t -1\; select-window -t -1

# Move window right
bind -n M-o swap-window -t +1\; select-window -t +1

# -----------------------------------------------------------------------------
# Prefix Key Tables (modal behavior like zellij)
# -----------------------------------------------------------------------------

# Quit/kill session (like zellij)
bind C-q confirm-before -p "Kill session #S? (y/n)" kill-session

# Pane mode
bind p switch-client -T pane

# Tab/window mode
bind t switch-client -T tab

# Resize mode
bind r switch-client -T resize

# Move mode
bind m switch-client -T move

# Enter scroll/copy mode (like zellij's scroll mode)
bind s copy-mode

# Enter copy mode
bind Enter copy-mode

# Detach from session (return to terminal without closing)
bind d detach-client

# Session mode
bind o switch-client -T session

# -----------------------------------------------------------------------------
# Pane Mode (prefix, p, then key)
# -----------------------------------------------------------------------------

bind -T pane n split-window -h -c "#{pane_current_path}"
bind -T pane r split-window -h -c "#{pane_current_path}"
bind -T pane d split-window -v -c "#{pane_current_path}"
bind -T pane s split-window -v -c "#{pane_current_path}"
bind -T pane h select-pane -L
bind -T pane j select-pane -D
bind -T pane k select-pane -U
bind -T pane l select-pane -R
bind -T pane Left select-pane -L
bind -T pane Down select-pane -D
bind -T pane Up select-pane -U
bind -T pane Right select-pane -R
bind -T pane x kill-pane
bind -T pane f resize-pane -Z
bind -T pane z resize-pane -Z
bind -T pane w display-panes
bind -T pane Tab select-pane -t :.+

# -----------------------------------------------------------------------------
# Tab/Window Mode (prefix, t, then key)
# -----------------------------------------------------------------------------

bind -T tab n new-window -c "#{pane_current_path}"
bind -T tab h previous-window
bind -T tab j next-window
bind -T tab k previous-window
bind -T tab l next-window
bind -T tab Left previous-window
bind -T tab Down next-window
bind -T tab Up previous-window
bind -T tab Right next-window
bind -T tab r command-prompt -I "#W" "rename-window '%%'"
bind -T tab x confirm-before -p "Kill window #W? (y/n)" kill-window
bind -T tab b break-pane
bind -T tab Tab last-window

# -----------------------------------------------------------------------------
# Resize Mode (prefix, r, then key)
# -----------------------------------------------------------------------------

bind -T resize h resize-pane -L 5
bind -T resize j resize-pane -D 5
bind -T resize k resize-pane -U 5
bind -T resize l resize-pane -R 5
bind -T resize Left resize-pane -L 5
bind -T resize Down resize-pane -D 5
bind -T resize Up resize-pane -U 5
bind -T resize Right resize-pane -R 5
bind -T resize H resize-pane -L 1
bind -T resize J resize-pane -D 1
bind -T resize K resize-pane -U 1
bind -T resize L resize-pane -R 1
bind -T resize + resize-pane -Z
bind -T resize - resize-pane -Z
bind -T resize = select-layout even-horizontal

# -----------------------------------------------------------------------------
# Move Mode (prefix, m, then key)
# -----------------------------------------------------------------------------

bind -T move h swap-pane -U
bind -T move j swap-pane -D
bind -T move k swap-pane -U
bind -T move l swap-pane -D
bind -T move Left swap-pane -U
bind -T move Down swap-pane -D
bind -T move Up swap-pane -U
bind -T move Right swap-pane -D

# -----------------------------------------------------------------------------
# Session Mode (prefix, o, then key)
# -----------------------------------------------------------------------------

bind -T session w choose-tree -Zs
bind -T session n command-prompt -p "New session:" "new-session -s '%%'"
bind -T session r command-prompt -I "#S" "rename-session '%%'"
bind -T session x confirm-before -p "Kill session #S? (y/n)" kill-session

# -----------------------------------------------------------------------------
# Copy Mode Enhancements (like zellij's scroll mode)
# -----------------------------------------------------------------------------

bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi h send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right
bind -T copy-mode-vi C-b send-keys -X page-up
bind -T copy-mode-vi C-f send-keys -X page-down
bind -T copy-mode-vi u send-keys -X halfpage-up
bind -T copy-mode-vi d send-keys -X halfpage-down
bind -T copy-mode-vi g send-keys -X history-top
bind -T copy-mode-vi G send-keys -X history-bottom
bind -T copy-mode-vi / command-prompt -p "(search down)" "send-keys -X search-forward '%%%'"
bind -T copy-mode-vi ? command-prompt -p "(search up)" "send-keys -X search-backward '%%%'"
bind -T copy-mode-vi n send-keys -X search-again
bind -T copy-mode-vi N send-keys -X search-reverse

# -----------------------------------------------------------------------------
# Status Bar (Tokyo Night theme with Powerline style)
# -----------------------------------------------------------------------------

set -g status on
set -g status-interval 5
set -g status-position bottom
set -g status-justify left
set -g status-style "bg=#1a1b26,fg=#a9b1d6"

# Left side: session name with powerline arrow
set -g status-left-length 50
set -g status-left "#[fg=#1a1b26,bg=#bb9af7,bold] #S #[fg=#bb9af7,bg=#1a1b26]"

# Right side: date and time with powerline arrows
set -g status-right-length 80
set -g status-right "#[fg=#3b4261,bg=#1a1b26] #[fg=#a9b1d6,bg=#3b4261] %a %b %d #[fg=#565f89]│ #[fg=#bb9af7]%H:%M #[fg=#7aa2f7,bg=#3b4261] #[fg=#1a1b26,bg=#7aa2f7,bold] #h "

# Window status (inactive)
setw -g window-status-format "#[fg=#565f89] #I #W #[fg=#3b4261]"
# Window status (active)
setw -g window-status-current-format "#[fg=#7aa2f7,bold] #I #W #[fg=#7aa2f7]"
setw -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#3b4261"
set -g pane-active-border-style "fg=#7aa2f7"
set -g pane-border-lines heavy

# Message styling
set -g message-style "bg=#7aa2f7,fg=#1a1b26,bold"

# Mode styling (copy mode, etc.)
setw -g mode-style "bg=#7aa2f7,fg=#1a1b26,bold"

# Plugin manager (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Initialize TPM (keep at very bottom)
# Install TPM: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Install plugins: prefix + I
run '~/.config/tmux/plugins/tpm/tpm'
